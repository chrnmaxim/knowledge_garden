---
title: Pytest
draft: false
tags:
  - Python
  - pytest
  - asyncio
---
ะะดะตัั ัะพะฑัะฐะฝั ะฟะพะปะตะทะฝัะต ัะธะบััััั Pytest ะดะปั ัะพะทะดะฐะฝะธั ัะตััะพะฒ FastAPI ะฟัะธะปะพะถะตะฝะธั ะฒ ะฐัะธะฝััะพะฝะฝะพะผ ัะตะถะธะผะต ั ะฟะพะดะบะปััะตะฝะธะตะผ ะบ ัะตััะพะฒะพะน ะะ PostgreSQL.
## ะะฐะฑะพัะฐ ั ะะ
### ะกะพะทะดะฐะฝะธะต ัะบะทะตะผะฟะปััะฐ ะดะฒะธะถะบะฐ

```python
from sqlalchemy.ext.asyncio import AsyncSession, create_async_engine

from sqlalchemy.orm import sessionmaker
from sqlalchemy.pool import NullPool

from src.database import Base


engine_test = create_async_engine(
ย ย url=<DATABASE_URL>,
ย ย poolclass=NullPool,
)

async_session_maker = sessionmaker(
ย ย bind=engine_test,
ย ย class_=AsyncSession,
ย ย expire_on_commit=False,
ย ย autocommit=False,
ย ย autoflush=False,
)
```

### ะคะธะบััััะฐ`prepare_database`
```python
@pytest.fixture(
ย ย autouse=True,
ย ย scope="module",
)

async def prepare_database():
ย ย """
ย ย ะกะฑัะฐััะฒะฐะตั ะธ ัะพะทะดะฐะตั ัะฐะฑะปะธัั ะฒ ะะ ะฟะตัะตะด ะทะฐะฟััะบะพะผ ะบะฐะถะดะพะณะพ ะผะพะดัะปั ั ัะตััะฐะผะธ.
ย ย
ย ย ะะพัะปะต ะฒัะฟะพะปะฝะตะฝะธั ะฒัะตั ัะตััะพะฒ ะฒ ะผะพะดัะปะต ัะฝะพะฒะฐ ัะฑัะฐััะฒะฐะตั ัะฐะฑะปะธัั ะฒ ะะ.
ย ย """

ย ย async with engine_test.begin() as conn:
ย ย ย ย await conn.run_sync(Base.metadata.drop_all)
ย ย ย ย await conn.run_sync(Base.metadata.create_all)
ย ย yield
ย ย async with engine_test.begin() as conn:
ย ย ย ย await conn.run_sync(Base.metadata.drop_all)
```

#### ะะฟะธัะฐะฝะธะต

- **`autouse=True`** โ ัะธะบััััะฐ ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฟัะธะผะตะฝัะตััั ะบะพ ะฒัะตะผ ัะตััะฐะผ ะฒ ะผะพะดัะปะต, ะตั ะฝะต ะฝัะถะฝะพ ัะฒะฝะพ ัะบะฐะทัะฒะฐัั ะฒ ัะตััะฐั.
- **`scope="module"`** โ ัะธะบััััะฐ ะฒัะฟะพะปะฝัะตััั ะพะดะธะฝ ัะฐะท ะฟะตัะตะด ะทะฐะฟััะบะพะผ ะฒัะตั ัะตััะพะฒ ะฒะฝัััะธ ะผะพะดัะปั ะธ ะทะฐะฒะตััะฐะตััั ะฟะพัะปะต ะฒัะฟะพะปะฝะตะฝะธั ะฒัะตั ัะตััะพะฒ ะธะท ััะพะณะพ ะผะพะดัะปั.

#### ะงัะพ ะดะตะปะฐะตั

- **ะะตัะตะด ะทะฐะฟััะบะพะผ ัะตััะพะฒ**:
    - ะะพะดะบะปััะฐะตััั ะบ ะฑะฐะทะต ะดะฐะฝะฝัั ัะตัะตะท `engine_test`.
    - ะฃะดะฐะปัะตั ะฒัะต ัะฐะฑะปะธัั ะฒ ะะ ั ะฟะพะผะพััั `Base.metadata.drop_all`.
    - ะกะพะทะดะฐัั ะฝะพะฒัะต ัะฐะฑะปะธัั ั ะฟะพะผะพััั `Base.metadata.create_all`.
- **ะะพัะปะต ะฒัะฟะพะปะฝะตะฝะธั ะฒัะตั ัะตััะพะฒ ะฒ ะผะพะดัะปะต**:
    - ะกะฝะพะฒะฐ ัะดะฐะปัะตั ะฒัะต ัะฐะฑะปะธัั ะฒ ะฑะฐะทะต ะดะฐะฝะฝัั.

ะขะฐะบะธะผ ะพะฑัะฐะทะพะผ, ัะธะบััััะฐ ะณะฐัะฐะฝัะธััะตั, ััะพ ะฑะฐะทะฐ ะดะฐะฝะฝัั ะฒัะตะณะดะฐ ะฝะฐัะพะดะธััั ะฒ ัะธััะพะผ ัะพััะพัะฝะธะธ ะฟะตัะตะด ะทะฐะฟััะบะพะผ ะธ ะฟะพัะปะต ะทะฐะฒะตััะตะฝะธั ัะตััะพะฒ ะฒ ะผะพะดัะปะต

### ะคะธะบััััะฐ `session`

```python
@pytest.fixture(scope="function")

async def session():
	"""
ย ย ะะพะดะบะปััะฐะตััั ะบ Postgres, ะฝะฐัะธะฝะฐะตั ััะฐะฝะทะฐะบัะธั, ะทะฐัะตะผ
ย ย ัะฒัะทัะฒะฐะตั ะตั ั ัะตััะธะตะน ั ะฒะปะพะถะตะฝะฝะพะน ััะฐะฝะทะฐะบัะธะตะน.

ย ย ะะปะพะถะตะฝะฝะฐั ััะฐะฝะทะฐะบัะธั ะฟะพะทะฒะพะปัะตั ะธะทะพะปะธัะพะฒะฐัั ะธะทะผะตะฝะตะฝะธั,
ย ย ัะฐะบ ััะพ ะพะฝะธ ะฒะธะดะฝั ัะพะปัะบะพ ะฒ ัะฐะผะบะฐั ัะตะบััะตะณะพ ัะตััะฐ, ะฝะพ ะฝะต ัะพััะฐะฝััััั ะฒ ะะ.
	"""



ย ย async with engine_test.connect() as conn:
ย ย ย ย tsx = await conn.begin()
ย ย ย ย async with async_session_maker(bind=conn) as _session:
ย ย ย ย ย ย nested_tsx = await conn.begin_nested()
ย ย ย ย ย ย
ย ย ย ย ย ย yield _session
ย ย ย ย ย ย
ย ย ย ย ย ย if nested_tsx.is_active:
ย ย ย ย ย ย ย ย await nested_tsx.rollback()
ย ย ย ย ย ย await tsx.rollback()
```

#### ะะฟะธัะฐะฝะธะต

- **`scope="function"`** โ ัะธะบััััะฐ ะทะฐะฟััะบะฐะตััั ะฟะตัะตะด ะบะฐะถะดัะผ ัะตััะพะผ ะธ ะทะฐะฒะตััะฐะตััั ะฟะพัะปะต ะบะฐะถะดะพะณะพ ัะตััะฐ.

#### ะงัะพ ะดะตะปะฐะตั

1. ะัะบััะฒะฐะตั ะฟะพะดะบะปััะตะฝะธะต ะบ ะฑะฐะทะต ะดะฐะฝะฝัั ั ะฟะพะผะพััั `engine_test.connect()`.
2. ะะฐะฟััะบะฐะตั ะฒะฝะตัะฝัั ััะฐะฝะทะฐะบัะธั ัะตัะตะท `conn.begin()`.
3. ะกะพะทะดะฐัั ัะตััะธั ั ะฟัะธะฒัะทะบะพะน ะบ ััะพะผั ัะพะตะดะธะฝะตะฝะธั ัะตัะตะท `async_session_maker(bind=conn)`.
4. ะะฐะฟััะบะฐะตั ะฒะปะพะถะตะฝะฝัั ััะฐะฝะทะฐะบัะธั ัะตัะตะท `conn.begin_nested()`. ะะปะพะถะตะฝะฝัะต ััะฐะฝะทะฐะบัะธะธ ะฟะพะปะตะทะฝั ะดะปั ัะพะณะพ, ััะพะฑั ะธะทะผะตะฝะตะฝะธั ะฑัะปะธ ะฒะธะดะฝั ัะพะปัะบะพ ะฒ ัะตะบััะตะผ ัะตััะต, ะฝะพ ะฝะต ะฒะปะธัะปะธ ะฝะฐ ะฑะฐะทั ะดะฐะฝะฝัั ะฒ ัะตะปะพะผ.
5. ะะพะทะฒัะฐัะฐะตั ัะพะทะดะฐะฝะฝัั ัะตััะธั ะดะปั ะธัะฟะพะปัะทะพะฒะฐะฝะธั ะฒ ัะตััะต.
6. ะะพัะปะต ะทะฐะฒะตััะตะฝะธั ัะตััะฐ:
    - ะัะปะธ ะฒะปะพะถะตะฝะฝะฐั ััะฐะฝะทะฐะบัะธั ะตัั ะฐะบัะธะฒะฝะฐ, ะพะฝะฐ ะพัะบะฐััะฒะฐะตััั.
    - ะัะบะฐััะฒะฐะตััั ะฒะฝะตัะฝัั ััะฐะฝะทะฐะบัะธั, ััะพ ะณะฐัะฐะฝัะธััะตั ะพััััััะฒะธะต ะธะทะผะตะฝะตะฝะธะน ะฒ ะฑะฐะทะต ะดะฐะฝะฝัั ะฟะพัะปะต ะฒัะฟะพะปะฝะตะฝะธั ัะตััะฐ.

ะญัะฐ ัะธะบััััะฐ ะพะฑะตัะฟะตัะธะฒะฐะตั ะธะทะพะปััะธั ะดะฐะฝะฝัั ะดะปั ะบะฐะถะดะพะณะพ ัะตััะฐ โ ะธะทะผะตะฝะตะฝะธั, ัะดะตะปะฐะฝะฝัะต ะฒ ัะพะดะต ะฒัะฟะพะปะฝะตะฝะธั ัะตััะฐ, ะฝะต ัะพััะฐะฝััััั ะฒ ะฑะฐะทะต ะดะฐะฝะฝัั.

----
๐ [[Python]]

ะะพัะปะตะดะฝะตะต ะธะทะผะตะฝะตะฝะธะต: 01.10.2024 16:22