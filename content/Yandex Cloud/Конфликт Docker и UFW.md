---
title: –ö–æ–Ω—Ñ–ª–∏–∫—Ç Docker –∏ UFW
draft: false
tags:
  - Docker
---
## –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
–ü—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ ufw –≤ Unix —Å–∏—Å—Ç–µ–º–∞—Ö –º–æ–∂–µ—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å —Å–∏—Ç—É–∞—Ü–∏—è, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–π Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–µ —Å–æ–±–ª—é–¥–∞—é—Ç –ø—Ä–∞–≤–∏–ª–∞ —Ñ–∞–π—Ä–≤–æ–ª–ª–∞.

–¢–∞–∫, –Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –ø–æ—Ä—Ç–∞—Ö —Ñ–∞–π—Ä–≤–æ–ª–ª–∞ ufw 80, 443 –∏ 22
```bash
# 80, 443
sudo ufw allow 'Nginx Full'
# 22
sudo ufw allow OpenSSH

sudo ufw enable
```
–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –ø—Ä–æ–±—Ä–æ—à–µ–Ω–Ω—ã–º–∏ –ø–æ—Ä—Ç–∞–º–∏ 8000:80 (8000 - —Ö–æ—Å—Ç, 80 - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä) –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ –≤–Ω–µ —Å –ø–æ—Ä—Ç–∞ 8000 —Ö–æ—Å—Ç–∞, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –ø—Ä–∞–≤–∏–ª–∞ —Ñ–∞–π—Ä–≤–æ–ª–ª–∞.
## –†–µ—à–µ–Ω–∏–µ
–î–ª—è —Ä–µ—à–µ–Ω–∏—è –¥–∞–Ω–Ω–æ–π –ø—Ä–æ–±–ª–µ–º—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ UFW `etc/ufw/after.rules`, –¥–æ–±–∞–≤–∏–≤ —Å–ª–µ–¥—É—é—â–∏–π –ª–∏—Å—Ç–∏–Ω–≥ –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞.

```bash
#BEGIN UFW AND DOCKER
*filter
:ufw-user-forward - [0:0]
:DOCKER-USER - [0:0]
-A DOCKER-USER -j RETURN -s 10.0.0.0/8
-A DOCKER-USER -j RETURN -s 172.16.0.0/12
-A DOCKER-USER -j RETURN -s 192.168.0.0/16

-A DOCKER-USER -j ufw-user-forward

-A DOCKER-USER -j DROP -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -d 192.168.0.0/16
-A DOCKER-USER -j DROP -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -d 10.0.0.0/8
-A DOCKER-USER -j DROP -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -d 172.16.0.0/12
-A DOCKER-USER -j DROP -p udp -m udp --dport 0:32767 -d 192.168.0.0/16
-A DOCKER-USER -j DROP -p udp -m udp --dport 0:32767 -d 10.0.0.0/8
-A DOCKER-USER -j DROP -p udp -m udp --dport 0:32767 -d 172.16.0.0/12

-A DOCKER-USER -j RETURN
COMMIT
# END UFW AND DOCKER
```

–î–∞–ª–µ–µ, –∏—Å–ø–æ–ª—å–∑—É—è –∫–æ–º–∞–Ω–¥—É
```bash
sudo systemctl restart ufw
```
–ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å UFW.
–¢–µ–ø–µ—Ä—å –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –æ—Ç–∫—Ä—ã—Ç—ã–º –ø–æ—Ä—Ç–∞–º Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏–∑ –≤–Ω–µ, –ø—Ä–∏ —ç—Ç–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –º–æ–≥—É—Ç "–æ–±—â–∞—Ç—å—Å—è" –º–µ–∂–¥—É —Å–æ–±–æ–π –∏ —Ç–∞–∫–∂–µ –∏–º–µ—é—Ç –¥–æ—Å—Ç—É–ø –∫–æ –≤–Ω–µ—à–Ω–µ–π —Å–µ—Ç–∏.
## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
–ï—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–º —Å–µ—Ç—è–º –¥–æ—Å—Ç—É–ø –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É Docker, –Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ –µ–≥–æ –ø–æ—Ä—Ç 80, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â—É—é –∫–æ–º–∞–Ω–¥—É, —á—Ç–æ–±—ã —Ä–∞–∑—Ä–µ—à–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–º —Å–µ—Ç—è–º –¥–æ—Å—Ç—É–ø –∫ —ç—Ç–æ–º—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É:
```bash
fw route allow proto tcp from any to any port 80
````
–≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—É–±–ª–∏—á–Ω—ã–º —Å–µ—Ç—è–º –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º —Å –ø–æ—Ä—Ç–æ–º 80.

*–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ*: –°–ª–µ–¥—É–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–º–µ–Ω–Ω–æ –ø–æ—Ä—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ 80, –∞ –Ω–µ –ø–æ—Ä—Ç —Ö–æ—Å—Ç–∞ 8000, –µ—Å–ª–∏ –ø–æ—Ä—Ç—ã –ø—Ä–æ–±—Ä–æ—à–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:
```bash
ports:
	- "HOST_PORT:CONTAINER_PORT:
	- "8000: 80"
```
–ï—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø—É—â–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —Å –ø–æ—Ä—Ç–æ–º 80, –Ω–æ –¥–æ—Å—Ç—É–ø –∏–∑ –≤–Ω–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ–º—É –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º—É, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â—É—é –∫–æ–º–∞–Ω–¥—É:
```bash
ufw route allow proto tcp from any to 172.17.0.2 port 80
```
`172.17.0.2` - –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π IP –∞–¥—Ä–µ—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.

–¢–∞–∫–∂–µ, –µ—Å–ª–∏ –ø—Ä–æ–∫–æ–ª —Å–µ—Ç–∏ - UDP, –Ω–∞–ø—Ä–∏–º–µ—Ä, DNS —Å–µ—Ä–≤–∏—Å, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
```bash
ufw route allow proto udp from any to any port 53
```
–ò –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º IP –∞–¥—Ä–µ—Å–æ–º `172.17.0.2` :
```bash
ufw route allow proto udp from any to 172.17.0.2 port 53
```
## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
–°–ª–µ–¥—É—é—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –ø–æ–∑–≤–æ–ª—è—é—Ç —á–∞—Å—Ç–Ω—ã–º —Å–µ—Ç—è–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è –¥—Ä—É–≥ –∫ –¥—Ä—É–≥—É.
```bash
-A DOCKER-USER -j RETURN -s 10.0.0.0/8
-A DOCKER-USER -j RETURN -s 172.16.0.0/12
-A DOCKER-USER -j RETURN -s 192.168.0.0/16
```
–°–ª–µ–¥—É—é—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –ø–æ–∑–≤–æ–ª—è—é—Ç UFW —É–ø—Ä–∞–≤–ª—è—Ç—å —Ç–µ–º, —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –ª–∏ –ø—É–±–ª–∏—á–Ω—ã–º —Å–µ—Ç—è–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º Docker.
```bash
-A DOCKER-USER -j ufw-user-forwar
```
–°–ª–µ–¥—É—é—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –±–ª–æ–∫–∏—Ä—É—é—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ, –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤—Å–µ–º–∏ –ø—É–±–ª–∏—á–Ω—ã–º–∏ —Å–µ—Ç—è–º–∏, –Ω–æ –ø–æ–∑–≤–æ–ª—è—é—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º —Å–µ—Ç—è–º –ø–æ–ª—É—á–∞—Ç—å –¥–æ—Å—Ç—É–ø –∫ –≤–Ω–µ—à–Ω–∏–º —Å–µ—Ç—è–º.
```bash
-A DOCKER-USER -j DROP -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -d 192.168.0.0/16
-A DOCKER-USER -j DROP -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -d 10.0.0.0/8
-A DOCKER-USER -j DROP -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -d 172.16.0.0/12
-A DOCKER-USER -j DROP -p udp -m udp --dport 0:32767 -d 192.168.0.0/16
-A DOCKER-USER -j DROP -p udp -m udp --dport 0:32767 -d 10.0.0.0/8
-A DOCKER-USER -j DROP -p udp -m udp --dport 0:32767 -d 172.16.0.0/12

-A DOCKER-USER -j RETURN
```
–î–ª—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ TCP –∑–∞–ø—Ä–µ—â–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ TCP-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏–∑ –ø—É–±–ª–∏—á–Ω—ã—Ö —Å–µ—Ç–µ–π.

–î–ª—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ UDP –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –≤—Å–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –ø–æ—Ä—Ç–∞–º —Å –Ω–æ–º–µ—Ä–æ–º –º–µ–Ω—å—à–µ 32767.

–ü–æ—á–µ–º—É –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –∏–º–µ–Ω–Ω–æ —ç—Ç–æ—Ç –ø–æ—Ä—Ç?
–ü–æ—Å–∫–æ–ª—å–∫—É –ø—Ä–æ—Ç–æ–∫–æ–ª UDP –Ω–µ –∏–º–µ–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è, –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å `handshake`, –∏–Ω–∏—Ü–∏–∏—Ä—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è, –∫–∞–∫ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç TCP.
–î–ª—è GNU/Linux –º—ã –º–æ–∂–µ–º –Ω–∞–π—Ç–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –ø–æ—Ä—Ç–æ–≤ –≤ —Ñ–∞–π–ª–µ `/proc/sys/net/ipv4/ip_local_port_range`.
–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–∏–∞–ø–∞–∑–æ–Ω —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç `32768: 60999`. –ü—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –ø—Ä–æ—Ç–æ–∫–æ–ª—É UDP –∏–∑ –∑–∞–ø—É—â–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ä—Ç –±—É–¥–µ—Ç –≤—ã–±—Ä–∞–Ω —Å–ª—É—á–∞–π–Ω—ã–º –æ–±—Ä–∞–∑–æ–º –∏–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≤—ã—à–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –ø–æ—Ä—Ç–æ–≤, –∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω–µ—Ç –¥–∞–Ω–Ω—ã–µ –Ω–∞ —ç—Ç–æ—Ç —Å–ª—É—á–∞–π–Ω—ã–π –ø–æ—Ä—Ç.
–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –º–æ–∂–Ω–æ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç—å, —á—Ç–æ –ø–æ—Ä—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ "—Å–ª—É—à–∞—é—Ç" –ø—Ä–æ—Ç–æ–∫–æ–ª UDP –≤–Ω—É—Ç—Ä–∏ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –º–µ–Ω—å—à–µ `32768`. –ò–º–µ–Ω–Ω–æ –ø–æ —ç—Ç–æ–π –ø—Ä–∏—á–∏–Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è  –æ–±—Ä–∞—â–µ–Ω–∏—è –ø—É–±–ª–∏—á–Ω—ã—Ö —Å–µ—Ç–µ–π  –∫ UDP-–ø–æ—Ä—Ç–∞–º, –∫–æ—Ç–æ—Ä—ã–µ –º–µ–Ω—å—à–µ 32768.

***[–ò—Å—Ç–æ—á–Ω–∏–∫](https://stackoverflow.com/a/51741599/23370921)***

----
üìÇ [[Yandex Cloud]]

C–æ–∑–¥–∞–Ω–æ: 18.09.2024 08:25

–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ: 20.09.2024 15:52